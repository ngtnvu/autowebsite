(function(e){e(function(){function i(){}function s(t){var n=new i;n.then=function(e){var n;try{if(e)n=e(t);return c(n===r?t:n)}catch(i){return o(i)}};return e(n)}function o(t){var n=new i;n.then=function(e,n){var i;try{if(n){i=n(t);return c(i===r?t:i)}return o(t)}catch(s){return o(s)}};return e(n)}function u(e){return l(e,function(e){return o(e)})}function a(){function p(e,t,n){return l(e,t,n)}function d(e){h(s(e))}function v(e){h(o(e))}function m(e){c(e)}var t,n,u,f,l,c,h;u=[];f=[];l=function(t, n,r){var i=a();u.push(function(e){e.then(t,n).then(i.resolve,i.reject,i.progress)});r&&f.push(r);return i.promise};c=function(e){var t,n=0;while(t=f[n++])t(e)};h=function(e){var t,n=0;l=e.then;h=c=function(){throw new Error("already completed");};f=r;while(t=u[n++])t(e);u=[]};t={};n=new i;n.then=t.then=p;t.promise=e(n);t.resolver=e({resolve:t.resolve=d,reject:t.reject=v,progress:t.progress=m});return t}function f(e){return e&&typeof e.then==="function"}function l(e,t,n,r){var i=c(e);return i.then(t, n,r)}function c(e){var t,n;if(e instanceof i)t=e;else{n=a();if(f(e)){e.then(n.resolve,n.reject,n.progress);t=n.promise}else{n.resolve(e);t=n.promise}}return t}function h(e,t,n,r,i){E(2,arguments);return l(e,function(e){function m(e){c(e)}function g(e){h(e)}function y(e){p(e)}function b(){c=h=p=S}var s,o,u,f,c,h,p,d,v;d=e.length>>>0;s=Math.max(0,Math.min(t,d));o=[];f=a();u=l(f,n,r,i);if(!s)f.resolve(o);else{c=function(e){o.push(e);if(!--s){b();f.resolve(o)}};h=function(e){b();f.reject(e)};p=f.progress; for(v=0;v<d;++v)if(v in e)l(e[v],m,g,y)}return u})}function p(e,t,n,r){E(1,arguments);return l(e,function(e){return b(e,d,[])}).then(t,n,r)}function d(e,t,n){e[n]=t;return e}function v(e,t,n,r){function i(e){return t?t(e[0]):e[0]}return h(e,1,i,n,r)}function m(e,t){return l(e,function(e){return g(e,t)})}function g(e,t){var n,r,i;r=e.length>>>0;n=new Array(r);for(i=0;i<r;i++)if(i in e)n[i]=l(e[i],t);return b(n,d,n)}function y(e,t,i){var s=n.call(arguments,1);return l(e,function(e){return b.apply(r, [e].concat(s))})}function b(e,n,r){var i,s;i=e.length;s=[function(e,t,r){return l(e,function(e){return l(t,function(t){return n(e,t,r,i)})})}];if(arguments.length>2)s.push(r);return t.apply(e,s)}function w(e,t,n){var r=arguments.length>2;return l(e,function(e){if(r)e=n;t.resolve(e);return e},function(e){t.reject(e);return o(e)},t.progress)}function E(e,t){var n,r=t.length;while(r>e){n=t[--r];if(n!=null&&typeof n!="function")throw new Error("callback is not a function");}}function S(){}var e,t,n,r; l.defer=a;l.reject=u;l.isPromise=f;l.all=p;l.some=h;l.any=v;l.map=m;l.reduce=y;l.chain=w;e=Object.freeze||function(e){return e};i.prototype=e({always:function(e,t){return this.then(e,e,t)},otherwise:function(e){return this.then(r,e)}});n=[].slice;t=[].reduce||function(e){var t,n,r,i,s;s=0;t=Object(this);i=t.length>>>0;n=arguments;if(n.length<=1)for(;;){if(s in t){r=t[s++];break}if(++s>=i)throw new TypeError;}else r=n[1];for(;s<i;++s)if(s in t)r=e(r,t[s],s,t);return r};return l})})(typeof define== "function"?define:function(e){typeof module!="undefined"?module.exports=e():jQuery.mapster_when=e()});