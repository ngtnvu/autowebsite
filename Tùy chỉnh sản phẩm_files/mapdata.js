(function(e){function r(t){e.extend(t,{complete:false,map:null,base_canvas:null,overlay_canvas:null,commands:[],data:[],mapAreas:[],_xref:{},highlightId:-1,currentAreaId:-1,_tooltip_events:[],scaleInfo:null,index:-1,activeAreaEvent:null})}function i(e){return[e,e.render_highlight,e.render_select]}function s(r){var s=r.options,o=r.images;if(t.hasCanvas()){e.each(s.altImages||{},function(e,t){o.add(t,e)});e.each([s].concat(s.areas),function(t,n){e.each(i(n),function(e,t){if(t&&t.altImage)t.altImageId= o.add(t.altImage)})})}r.area_options=n.updateProps({},t.area_defaults,s)}function o(e,t,r,i){function s(t){if(e.currentAreaId!==t&&e.highlightId>=0)i.resolve()}i=i||n.when.defer();if(e.activeAreaEvent){window.clearTimeout(e.activeAreaEvent);e.activeAreaEvent=0}if(t<0)i.reject();else if(r.owner.currentAction||t)e.activeAreaEvent=window.setTimeout(function(){return function(){o(e,0,r,i)}}(r),t||100);else s(r.areaId);return i}function u(e){if(!t.hasCanvas())this.blur();e.preventDefault()}function a(t, n){var r=t.getAllDataForArea(this),i=r.length?r[0]:null;if(!i||i.isNotRendered()||i.owner.currentAction)return;if(t.currentAreaId===i.areaId)return;if(t.highlightId!==i.areaId){t.clearEffects();i.highlight();if(t.options.showToolTip)e.each(r,function(e,t){if(t.effectiveOptions().toolTip)t.showToolTip()})}t.currentAreaId=i.areaId;if(e.isFunction(t.options.onMouseover))t.options.onMouseover.call(this,{e:n,options:i.effectiveOptions(),key:i.key,selected:i.isSelected()})}function f(t,n){var r,i=t.getDataForArea(this), s=t.options;if(t.currentAreaId<0||!i)return;r=t.getDataForArea(n.relatedTarget);if(r===i)return;t.currentAreaId=-1;i.area=null;o(t,s.mouseoutDelay,i).then(t.clearEffects);if(e.isFunction(s.onMouseout))s.onMouseout.call(this,{e:n,options:s,key:i.key,selected:i.isSelected()})}function l(t){var n=t.options;t.ensureNoHighlight();if(n.toolTipClose&&e.inArray("area-mouseout",n.toolTipClose)>=0&&t.activeToolTip)t.clearToolTip()}function c(r,i){function v(u){var p,g;l=u.isSelectable()&&(u.isDeselectable()|| !u.isSelected());if(l)f=!u.isSelected();else f=u.isSelected();a=t.getBoundList(d,u.key);if(e.isFunction(d.onClick)){c=d.onClick.call(h,{e:i,listTarget:a,key:u.key,selected:f});if(n.isBool(c)){if(!c)return false;g=e(u.area).attr("href");if(g!=="#"){window.location.href=g;return false}}}if(l)s=u.toggle();if(d.boundList&&d.boundList.length>0)t.setBoundListProperties(d,a,u.isSelected());p=u.effectiveOptions();if(p.includeKeys){o=n.split(p.includeKeys);e.each(o,function(e,t){var n=r.getDataForKey(t.toString()); if(!n.options.isMask)v(n)})}}var s,o,a,f,l,c,h=this,p=r.getDataForArea(this),d=r.options;u.call(this,i);if(d.clickNavigate&&p.href){window.location.href=p.href;return}if(p&&!p.owner.currentAction){d=r.options;v(p)}}var t=e.mapster,n=t.utils;t.MapData=function(e,n){var i=this;i.image=e;i.images=new t.MapImages(i);i.graphics=new t.Graphics(i);i.imgCssText=e.style.cssText||null;r(i);i.configureOptions(n);i.mouseover=function(e){a.call(this,i,e)};i.mouseout=function(e){f.call(this,i,e)};i.click=function(e){c.call(this, i,e)};i.clearEffects=function(e){l.call(this,i,e)}};t.MapData.prototype={constructor:t.MapData,configureOptions:function(e){this.options=n.updateProps({},t.defaults,e)},bindImages:function(){var e=this,t=e.images;if(t.length>2)t.splice(2);else if(t.length===0){t.add(e.image);t.add(e.image.src)}s(e);return e.images.bind()},isActive:function(){return!this.complete||this.currentAction},state:function(){return{complete:this.complete,resizing:this.currentAction==="resizing",zoomed:this.zoomed,zoomedArea:this.zoomedArea, scaleInfo:this.scaleInfo}},wrapId:function(){return"mapster_wrap_"+this.index},_idFromKey:function(e){return typeof e==="string"&&this._xref.hasOwnProperty(e)?this._xref[e]:-1},getSelected:function(){var t="";e.each(this.data,function(e,n){if(n.isSelected())t+=(t?",":"")+this.key});return t},getAllDataForArea:function(t,r){var i,s,o,u=this,a=e(t).filter("area").attr(u.options.mapKey);if(a){o=[];a=n.split(a);for(i=0;i<(r||a.length);i++){s=u.data[u._idFromKey(a[i])];s.area=t.length?t[0]:t;o.push(s)}}return o}, getDataForArea:function(e){var t=this.getAllDataForArea(e,1);return t?t[0]||null:null},getDataForKey:function(e){return this.data[this._idFromKey(e)]},getKeysForGroup:function(e){var t=this.getDataForKey(e);return!t?"":t.isPrimary?t.key:this.getPrimaryKeysForMapAreas(t.areas()).join(",")},getPrimaryKeysForMapAreas:function(t){var n=[];e.each(t,function(t,r){if(e.inArray(r.keys[0],n)<0)n.push(r.keys[0])});return n},getData:function(e){if(typeof e==="string")return this.getDataForKey(e);else if(e&& e.mapster||n.isElement(e))return this.getDataForArea(e);else return null},ensureNoHighlight:function(){var e;if(this.highlightId>=0){this.graphics.clearHighlight();e=this.data[this.highlightId];e.changeState("highlight",false);this.setHighlightId(-1)}},setHighlightId:function(e){this.highlightId=e},clearSelections:function(){e.each(this.data,function(e,t){if(t.selected)t.deselect(true)});this.removeSelectionFinish()},setAreaOptions:function(e){var t,r,i;e=e||[];for(t=e.length-1;t>=0;t--){r=e[t];if(r){i= this.getDataForKey(r.key);if(i){n.updateProps(i.options,r);if(n.isBool(r.selected))i.selected=r.selected}}}},drawSelections:function(e){var t,r=n.asArray(e);for(t=r.length-1;t>=0;t--)this.data[r[t]].drawSelection()},redrawSelections:function(){e.each(this.data,function(e,t){if(t.isSelectedOrStatic())t.drawSelection()})},initialize:function(){var r,i,s,o,u,a,f,l,c,h,p,d,v=this,g=v.options;if(v.complete)return;c=e(v.image);u=c.parent().attr("id");if(u&&u.length>=12&&u.substring(0,12)==="mapster_wrap"){o= c.parent();o.attr("id",v.wrapId())}else{o=e('<div id="'+v.wrapId()+'"></div>');if(g.wrapClass)if(g.wrapClass===true)o.addClass(c[0].className);else o.addClass(g.wrapClass)}v.wrapper=o;v.scaleInfo=d=n.scaleMap(v.images[0],v.images[1],g.scaleMap);v.base_canvas=i=v.graphics.createVisibleCanvas(v);v.overlay_canvas=s=v.graphics.createVisibleCanvas(v);r=e(v.images[1]).addClass("mapster_el "+v.images[0].className).attr({id:null,usemap:null});l=n.size(v.images[0]);if(l.complete)r.css({width:l.width,height:l.height}); v.buildDataset();a={display:"block",position:"relative",padding:0,width:d.width,height:d.height};if(g.wrapCss)e.extend(a,g.wrapCss);if(c.parent()[0]!==v.wrapper[0])c.before(v.wrapper);o.css(a);e(v.images.slice(2)).hide();for(f=1;f<v.images.length;f++)o.append(v.images[f]);o.append(i).append(s).append(c.css(t.canvas_style));n.setOpacity(v.images[0],0);e(v.images[1]).show();n.setOpacity(v.images[1],1);if(g.isSelectable&&g.onGetList){p=v.data.slice(0);if(g.sortList){if(g.sortList==="desc")h=function(e, t){return e===t?0:e>t?-1:1};else h=function(e,t){return e===t?0:e<t?-1:1};p.sort(function(e,t){e=e.value;t=t.value;return h(e,t)})}v.options.boundList=g.onGetList.call(v.image,p)}v.complete=true;v.processCommandQueue();if(g.onConfigured&&typeof g.onConfigured==="function")g.onConfigured.call(c,true)},buildDataset:function(n){function E(e,n){var r=new t.AreaData(y,e,n);r.areaId=y._xref[e]=y.data.push(r)-1;return r.areaId}var r,i,s,o,u,a,f,l,c,h,p,d,v,g,y=this,b=y.options,w;y._xref={};y.data=[];if(!n)y.mapAreas= [];w=!b.mapKey;if(w)b.mapKey="data-mapster-key";r=t.hasVml()?"area":w?"area[coords]":"area["+b.mapKey+"]";i=e(y.map).find(r).unbind(".mapster");for(p=0;p<i.length;p++){o=0;a=i[p];u=e(a);if(!a.coords)continue;if(w){f=String(p);u.attr("data-mapster-key",f)}else f=a.getAttribute(b.mapKey);if(n){l=y.mapAreas[u.data("mapster")-1];l.configure(f)}else{l=new t.MapArea(y,a,f);y.mapAreas.push(l)}h=l.keys;for(s=h.length-1;s>=0;s--){c=h[s];if(b.mapValue)d=u.attr(b.mapValue);if(w){o=E(y.data.length,d);v=y.data[o]; v.key=c=o.toString()}else{o=y._xref[c];if(o>=0){v=y.data[o];if(d&&!y.data[o].value)v.value=d}else{o=E(c,d);v=y.data[o];v.isPrimary=s===0}}l.areaDataXref.push(o);v.areasXref.push(p)}g=u.attr("href");if(g&&g!=="#"&&!v.href)v.href=g;if(!l.nohref)u.bind("click.mapster",y.click).bind("mouseover.mapster",y.mouseover).bind("mouseout.mapster",y.mouseout).bind("mousedown.mapster",y.mousedown);u.data("mapster",p+1)}y.setAreaOptions(b.areas);y.redrawSelections()},processCommandQueue:function(){var e,n=this; while(!n.currentAction&&n.commands.length){e=n.commands[0];n.commands.splice(0,1);t.impl[e.command].apply(e.that,e.args)}},clearEvents:function(){e(this.map).find("area").unbind(".mapster");e(this.images).unbind(".mapster")},_clearCanvases:function(t){if(!t)e(this.base_canvas).remove();e(this.overlay_canvas).remove()},clearMapData:function(t){var r=this;this._clearCanvases(t);e.each(this.data,function(e,t){t.reset()});this.data=null;if(!t){this.image.style.cssText=this.imgCssText;e(this.wrapper).before(this.image).remove()}r.images.clear(); this.image=null;n.ifFunction(this.clearTooltip,this)},removeSelectionFinish:function(){var e=this.graphics;e.refreshSelections();e.clearHighlight()}}})(jQuery);