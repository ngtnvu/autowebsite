(function(e){function o(t,n,r){var i=t,s=i.map_data,o=r.isMask;e.each(n.areas(),function(e,t){r.isMask=o||t.nohref&&s.options.noHrefIsMask;i.addShape(t,r)});r.isMask=o}function u(e){return Math.max(0,Math.min(parseInt(e,16),255))}function a(e,t){return"rgba("+u(e.substr(0,2))+","+u(e.substr(2,2))+","+u(e.substr(4,2))+","+t+")"}function f(){}var t,n=e.mapster,r=n.utils,i,s;n.Graphics=function(e){var t=this;t.active=false;t.canvas=null;t.width=0;t.height=0;t.shapes=[];t.masks=[];t.map_data=e};t=n.Graphics.prototype= {constructor:n.Graphics,begin:function(t,n){var r=e(t);this.elementName=n;this.canvas=t;this.width=r.width();this.height=r.height();this.shapes=[];this.masks=[];this.active=true},addShape:function(e,t){var n=t.isMask?this.masks:this.shapes;n.push({mapArea:e,options:t})},createVisibleCanvas:function(t){return e(this.createCanvasFor(t)).addClass("mapster_el").css(n.canvas_style)[0]},addShapeGroup:function(t,i,s){var u=this,a,f,l,c=this.map_data,h=t.effectiveRenderOptions(i);if(s)e.extend(h,s);if(i=== "select"){f="static_"+t.areaId.toString();l=c.base_canvas}else l=c.overlay_canvas;u.begin(l,f);if(h.includeKeys){a=r.split(h.includeKeys);e.each(a,function(e,t){var n=c.getDataForKey(t.toString());o(u,n,n.effectiveRenderOptions(i))})}o(u,t,h);u.render();if(h.fade)r.fader(n.hasCanvas()?l:e(l).find("._fill").not(".mapster_mask"),0,n.hasCanvas()?1:h.fillOpacity,h.fadeDuration)}};i={renderShape:function(e,t,n){var r,i=t.coords(null,n);switch(t.shape){case "rect":e.rect(i[0],i[1],i[2]-i[0],i[3]-i[1]); break;case "poly":e.moveTo(i[0],i[1]);for(r=2;r<t.length;r+=2)e.lineTo(i[r],i[r+1]);e.lineTo(i[0],i[1]);break;case "circ":case "circle":e.arc(i[0],i[1],i[2],0,Math.PI*2,false);break}},addAltImage:function(e,t,n,r){e.beginPath();this.renderShape(e,n);e.closePath();e.clip();e.globalAlpha=r.altImageOpacity||r.fillOpacity;e.drawImage(t,0,0,n.owner.scaleInfo.width,n.owner.scaleInfo.height)},render:function(){var t,n,r=this,i=r.map_data,s=r.masks.length,o=r.createCanvasFor(i),u=o.getContext("2d"),f=r.canvas.getContext("2d"); if(s){t=r.createCanvasFor(i);n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);e.each(r.masks,function(e,t){n.save();n.beginPath();r.renderShape(n,t.mapArea);n.closePath();n.clip();n.lineWidth=0;n.fillStyle="#000";n.fill();n.restore()})}e.each(r.shapes,function(e,t){u.save();if(t.options.fill)if(t.options.altImageId)r.addAltImage(u,i.images[t.options.altImageId],t.mapArea,t.options);else{u.beginPath();r.renderShape(u,t.mapArea);u.closePath();u.fillStyle=a(t.options.fillColor,t.options.fillOpacity); u.fill()}u.restore()});e.each(r.shapes.concat(r.masks),function(e,t){var n=t.options.strokeWidth===1?.5:0;if(t.options.stroke){u.save();u.strokeStyle=a(t.options.strokeColor,t.options.strokeOpacity);u.lineWidth=t.options.strokeWidth;u.beginPath();r.renderShape(u,t.mapArea,n);u.closePath();u.stroke();u.restore()}});if(s){n.globalCompositeOperation="source-out";n.drawImage(o,0,0);f.drawImage(t,0,0)}else f.drawImage(o,0,0);r.active=false;return r.canvas},createCanvasFor:function(t){return e('<canvas width="'+ t.scaleInfo.width+'" height="'+t.scaleInfo.height+'"></canvas>')[0]},clearHighlight:function(){var e=this.map_data.overlay_canvas;e.getContext("2d").clearRect(0,0,e.width,e.height)},refreshSelections:function(){var t,n=this.map_data;t=n.base_canvas;n.base_canvas=this.createVisibleCanvas(n);e(n.base_canvas).hide();e(t).before(n.base_canvas);n.redrawSelections();e(n.base_canvas).show();e(t).remove()}};s={renderShape:function(t,n,r){var i=this,s,o,u,a,f,l,c,h=t.coords();f=i.elementName?'name="'+i.elementName+ '" ':"";l=r?'class="'+r+'" ':"";a='<v:fill color="#'+n.fillColor+'" class="_fill" opacity="'+(n.fill?n.fillOpacity:0)+'" /><v:stroke class="_fill" opacity="'+n.strokeOpacity+'"/>';o=n.stroke?" strokeweight="+n.strokeWidth+' stroked="t" strokecolor="#'+n.strokeColor+'"':' stroked="f"';s=n.fill?' filled="t"':' filled="f"';switch(t.shape){case "rect":c="<v:rect "+l+f+s+o+' style="zoom:1;margin:0;padding:0;display:block;position:absolute;left:'+h[0]+"px;top:"+h[1]+"px;width:"+(h[2]-h[0])+"px;height:"+ (h[3]-h[1])+'px;">'+a+"</v:rect>";break;case "poly":c="<v:shape "+l+f+s+o+' coordorigin="0,0" coordsize="'+i.width+","+i.height+'" path="m '+h[0]+","+h[1]+" l "+h.slice(2).join(",")+' x e" style="zoom:1;margin:0;padding:0;display:block;position:absolute;top:0px;left:0px;width:'+i.width+"px;height:"+i.height+'px;">'+a+"</v:shape>";break;case "circ":case "circle":c="<v:oval "+l+f+s+o+' style="zoom:1;margin:0;padding:0;display:block;position:absolute;left:'+(h[0]-h[2])+"px;top:"+(h[1]-h[2])+"px;width:"+ h[2]*2+"px;height:"+h[2]*2+'px;">'+a+"</v:oval>";break}u=e(c);e(i.canvas).append(u);return u},render:function(){var t,n=this;e.each(this.shapes,function(e,t){n.renderShape(t.mapArea,t.options)});if(this.masks.length)e.each(this.masks,function(e,i){t=r.updateProps({},i.options,{fillOpacity:1,fillColor:i.options.fillColorMask});n.renderShape(i.mapArea,t,"mapster_mask")});this.active=false;return this.canvas},createCanvasFor:function(t){var n=t.scaleInfo.width,r=t.scaleInfo.height;return e('<var width="'+ n+'" height="'+r+'" style="zoom:1;overflow:hidden;display:block;width:'+n+"px;height:"+r+'px;"></var>')[0]},clearHighlight:function(){e(this.map_data.overlay_canvas).children().remove()},removeSelections:function(t){if(t>=0)e(this.map_data.base_canvas).find('[name="static_'+t.toString()+'"]').remove();else e(this.map_data.base_canvas).children().remove()}};e.each(["renderShape","addAltImage","render","createCanvasFor","clearHighlight","removeSelections","refreshSelections"],function(e,r){t[r]=function(e){return function(){t[e]= (n.hasCanvas()?i[e]:s[e])||f;return t[e].apply(this,arguments)}}(r)})})(jQuery);