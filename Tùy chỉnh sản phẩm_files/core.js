(function($){$.fn.mapster=function(e){var t=$.mapster.impl;if($.isFunction(t[e]))return t[e].apply(this,Array.prototype.slice.call(arguments,1));else if(typeof e==="object"||!e)return t.bind.apply(this,arguments);else $.error("Method "+e+" does not exist on jQuery.mapster")};$.mapster={version:"1.2.14-beta1",render_defaults:{isSelectable:true,isDeselectable:true,fade:false,fadeDuration:150,fill:true,fillColor:"000000",fillColorMask:"FFFFFF",fillOpacity:.7,highlight:true,stroke:false,strokeColor:"ff0000", strokeOpacity:1,strokeWidth:1,includeKeys:"",altImage:null,altImageId:null,altImages:{}},defaults:{clickNavigate:false,wrapClass:null,wrapCss:null,onGetList:null,sortList:false,listenToList:false,mapKey:"",mapValue:"",singleSelect:false,listKey:"value",listSelectedAttribute:"selected",listSelectedClass:null,onClick:null,onMouseover:null,onMouseout:null,mouseoutDelay:0,onStateChange:null,boundList:null,onConfigured:null,configTimeout:3E4,noHrefIsMask:true,scaleMap:true,safeLoad:false,areas:[]},shared_defaults:{render_highlight:{fade:true}, render_select:{fade:false},staticState:null,selected:null},area_defaults:{includeKeys:"",isMask:false},canvas_style:{position:"absolute",left:0,top:0,padding:0,border:0},hasCanvas:null,isTouch:null,map_cache:[],hooks:{},addHook:function(e,t){this.hooks[e]=(this.hooks[e]||[]).push(t)},callHooks:function(e,t){$.each(this.hooks[e]||[],function(e,n){n.apply(t)})},utils:{when:$.mapster_when,defer:$.mapster_when.defer,subclass:function(e,t){var n=function(){var n=this,r=Array.prototype.slice.call(arguments, 0);n.base=e.prototype;n.base.init=function(){e.prototype.constructor.apply(n,r)};t.apply(n,r)};n.prototype=new e;n.prototype.constructor=n;return n},asArray:function(e){return e.constructor===Array?e:this.split(e)},split:function(e,t){var n,r,i=e.split(",");for(n=0;n<i.length;n++){r=$.trim(i[n]);if(r==="")i.splice(n,1);else i[n]=t?t(r):r}return i},updateProps:function(e,t){var n,r=e||{},i=$.isEmptyObject(r)?t:e;n=[];$.each(i,function(e){n.push(e)});$.each(Array.prototype.slice.call(arguments,1),function(e, t){$.each(t||{},function(e){if(!n||$.inArray(e,n)>=0){var i=t[e];if($.isPlainObject(i))r[e]=$.extend(r[e]||{},i);else if(i&&i.constructor===Array)r[e]=i.slice(0);else if(typeof i!=="undefined")r[e]=t[e]}})});return r},isElement:function(e){return typeof HTMLElement==="object"?e instanceof HTMLElement:e&&typeof e==="object"&&e.nodeType===1&&typeof e.nodeName==="string"},indexOf:function(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return n;return-1},indexOfProp:function(e,t,n){var r=e.constructor=== Array?-1:null;$.each(e,function(e,i){if(i&&(t?i[t]:i)===n){r=e;return false}});return r},boolOrDefault:function(e,t){return this.isBool(e)?e:t||false},isBool:function(e){return typeof e==="boolean"},isUndef:function(e){return typeof e==="undefined"},ifFunction:function(e,t,n){if($.isFunction(e))e.call(t,n)},size:function(e,t){var n=$.mapster.utils;return{width:t?e.width||e.naturalWidth:n.imgWidth(e,true),height:t?e.height||e.naturalHeight:n.imgHeight(e,true),complete:function(){return!!this.height&& !!this.width}}},setOpacity:function(e,t){if($.mapster.hasCanvas())e.style.opacity=t;else $(e).each(function(e,n){if(typeof n.opacity!=="undefined")n.opacity=t;else $(n).css("opacity",t)})},fader:function(){var e={},t=0,n=function(r,i,s,o){var u,a=o/15,f,l=$.mapster.utils;if(typeof r==="number"){f=e[r];if(!f)return}else{u=l.indexOfProp(e,null,r);if(u)delete e[u];e[++t]=f=r;r=t}s=s||1;i=i+s/a>s-.01?s:i+s/a;l.setOpacity(f,i);if(i<s)setTimeout(function(){n(r,i,s,o)},15)};return n}()},getBoundList:function(e, t){if(!e.boundList)return null;var n,r,i=$(),s=$.mapster.utils.split(t);e.boundList.each(function(t,o){for(n=0;n<s.length;n++){r=s[n];if($(o).is("["+e.listKey+'="'+r+'"]'))i=i.add(o)}});return i},setBoundListProperties:function(e,t,n){t.each(function(t,r){if(e.listSelectedClass)if(n)$(r).addClass(e.listSelectedClass);else $(r).removeClass(e.listSelectedClass);if(e.listSelectedAttribute)$(r).attr(e.listSelectedAttribute,n)})},getMapDataIndex:function(e){var t,n;switch(e.tagName&&e.tagName.toLowerCase()){case "area":n= $(e).parent().attr("name");t=$("img[usemap='#"+n+"']")[0];break;case "img":t=e;break}return t?this.utils.indexOfProp(this.map_cache,"image",t):-1},getMapData:function(e){var t=this.getMapDataIndex(e.length?e[0]:e);if(t>=0)return t>=0?this.map_cache[t]:null},queueCommand:function(e,t,n,r){if(!e)return false;if(!e.complete||e.currentAction){e.commands.push({that:t,command:n,args:r});return true}return false},unload:function(){this.impl.unload();this.utils=null;this.impl=null;$.fn.mapster=null;$.mapster= null;$("*").unbind()}};var m=$.mapster,u=m.utils,ap=Array.prototype;$.each(["width","height"],function(e,t){var n=t.substr(0,1).toUpperCase()+t.substr(1);u["img"+n]=function(e,r){return(r?$(e)[t]():0)||e[t]||e["natural"+n]||e["client"+n]||e["offset"+n]}});m.Method=function(e,t,n,r){var i=this;i.name=r.name;i.output=e;i.input=e;i.first=r.first||false;i.args=r.args?ap.slice.call(r.args,0):[];i.key=r.key;i.func_map=t;i.func_area=n;i.name=r.name;i.allowAsync=r.allowAsync||false};m.Method.prototype={constructor:m.Method, go:function(){var e,t,n,r,i,s=this.input,o=[],u=this;r=s.length;for(e=0;e<r;e++){t=$.mapster.getMapData(s[e]);if(t){if(!u.allowAsync&&m.queueCommand(t,u.input,u.name,u.args)){if(this.first)i="";continue}n=t.getData(s[e].nodeName==="AREA"?s[e]:this.key);if(n){if($.inArray(n,o)<0)o.push(n)}else i=this.func_map.apply(t,u.args);if(this.first||typeof i!=="undefined")break}}$(o).each(function(e,t){i=u.func_area.apply(t,u.args)});if(typeof i!=="undefined")return i;else return this.output}};$.mapster.impl= function(){function hasVml(){var e=$("<div />").appendTo("body");e.html('<v:shape id="vml_flag1" adj="1" />');var t=e[0].firstChild;t.style.behavior="url(#default#VML)";var n=t?typeof t.adj==="object":true;e.remove();return n}function namespaces(){return typeof document.namespaces==="object"?document.namespaces:null}function hasCanvas(){var e=namespaces();return e&&e.g_vml_?false:$("<canvas />")[0].getContext?true:false}function merge_areas(e,t){var n,r,i=e.options.areas;if(t)$.each(t,function(t, s){if(!s||!s.key)return;r=u.indexOfProp(i,"key",s.key);if(r>=0)$.extend(i[r],s);else i.push(s);n=e.getDataForKey(s.key);if(n)$.extend(n.options,s)})}function merge_options(e,t){var n=u.updateProps({},t);delete n.areas;u.updateProps(e.options,n);merge_areas(e,t.areas);u.updateProps(e.area_options,e.options)}var me={},addMap=function(e){return m.map_cache.push(e)-1},removeMap=function(e){m.map_cache.splice(e.index,1);for(var t=m.map_cache.length-1;t>=this.index;t--)m.map_cache[t].index--};me.get=function(e){var t= m.getMapData(this);if(!(t&&t.complete))throw"Can't access data until binding complete.";return(new m.Method(this,function(){return this.getSelected()},function(){return this.isSelected()},{name:"get",args:arguments,key:e,first:true,allowAsync:true,defaultReturn:""})).go()};me.data=function(e){return(new m.Method(this,null,function(){return this},{name:"data",args:arguments,key:e})).go()};me.highlight=function(e){return(new m.Method(this,function(){if(e===false)this.ensureNoHighlight();else{var t= this.highlightId;return t>=0?this.data[t].key:null}},function(){this.highlight()},{name:"highlight",args:arguments,key:e,first:true})).go()};me.keys=function(e,t){function i(e){var r,i=[];if(!t)i.push(e.key);else{r=e.areas();$.each(r,function(e,t){i=i.concat(t.keys)})}$.each(i,function(e,t){if($.inArray(t,n)<0)n.push(t)})}var n=[],r=m.getMapData(this);if(!(r&&r.complete))throw"Can't access data until binding complete.";if(!(r&&r.complete))return"";if(typeof e==="string")if(t)i(r.getDataForKey(e)); else n=[r.getKeysForGroup(e)];else{t=e;this.each(function(e,t){if(t.nodeName==="AREA")i(r.getDataForArea(t))})}return n.join(",")};me.select=function(){me.set.call(this,true)};me.deselect=function(){me.set.call(this,false)};me.set=function(e,t,n){function f(t){var n=e;if(t){switch(e){case true:t.select(s);break;case false:t.deselect(true);break;default:n=t.toggle(s);break}return n}}function l(e){if(e&&$.inArray(e,a)<0){a.push(e);o+=(o===""?"":",")+e.key}}function c(t){$.each(a,function(e,n){var r= f(n);if(t.options.boundList)m.setBoundListProperties(t.options,m.getBoundList(t.options,o),r)});if(!e)t.removeSelectionFinish()}var r,i,s=n,o,a;this.filter("img,area").each(function(n,f){var h;i=m.getMapData(f);if(i!==r){if(r)c(r);a=[];o=""}if(i){h="";if(f.nodeName.toUpperCase()==="IMG"){if(!m.queueCommand(i,$(f),"set",[e,t,s])){if(t instanceof Array){if(t.length)h=t.join(",")}else h=t;if(h)$.each(u.split(h),function(e,t){l(i.getDataForKey(t.toString()));r=i})}}else{s=t;if(!m.queueCommand(i,$(f), "set",[e,s])){l(i.getDataForArea(f));r=i}}}});if(i)c(i);return this};me.unbind=function(e){return(new m.Method(this,function(){this.clearEvents();this.clearMapData(e);removeMap(this)},null,{name:"unbind",args:arguments})).go()};me.rebind=function(e){return(new m.Method(this,function(){var t=this;t.complete=false;t.configureOptions(e);t.bindImages().then(function(){t.buildDataset(true);t.complete=true})},null,{name:"rebind",args:arguments})).go()};me.get_options=function(e,t){var n=u.isBool(e)?e:t; return(new m.Method(this,function(){var e=$.extend({},this.options);if(n){e.render_select=u.updateProps({},m.render_defaults,e,e.render_select);e.render_highlight=u.updateProps({},m.render_defaults,e,e.render_highlight)}return e},function(){return n?this.effectiveOptions():this.options},{name:"get_options",args:arguments,first:true,allowAsync:true,key:e})).go()};me.set_options=function(e){return(new m.Method(this,function(){merge_options(this,e)},null,{name:"set_options",args:arguments})).go()};me.unload= function(){var e;for(e=m.map_cache.length-1;e>=0;e--)if(m.map_cache[e])me.unbind.call($(m.map_cache[e].image));me.graphics=null};me.snapshot=function(){return(new m.Method(this,function(){$.each(this.data,function(e,t){t.selected=false});this.base_canvas=this.graphics.createVisibleCanvas(this);$(this.image).before(this.base_canvas)},null,{name:"snapshot"})).go()};me.state=function(){var e,t=null;$(this).each(function(n,r){if(r.nodeName==="IMG"){e=m.getMapData(r);if(e)t=e.state();return false}});return t}; me.bind=function(e){return this.each(function(t,n){var r,i,s,o;r=$(n);o=m.getMapData(n);if(o){me.unbind.apply(r);if(!o.complete){r.bind();return true}o=null}s=this.getAttribute("usemap");i=s&&$('map[name="'+s.substr(1)+'"]');if(!(r.is("img")&&s&&i.size()>0))return true;r.css("border",0);if(!o){o=new m.MapData(this,e);o.index=addMap(o);o.map=i;o.bindImages().then(function(){o.initialize()})}})};me.init=function(e){var t,n;m.hasCanvas=function(){if(!u.isBool(m.hasCanvas.value))m.hasCanvas.value=u.isBool(e)? e:hasCanvas();return m.hasCanvas.value};m.hasVml=function(){if(!u.isBool(m.hasVml.value)){var e=namespaces();if(e&&!e.v){e.add("v","urn:schemas-microsoft-com:vml");t=document.createStyleSheet();n=["shape","rect","oval","circ","fill","stroke","imagedata","group","textbox"];$.each(n,function(e,n){t.addRule("v\\:"+n,"behavior: url(#default#VML); antialias:true")})}m.hasVml.value=hasVml()}return m.hasVml.value};m.isTouch=!!document.documentElement.ontouchstart;u.indexOf=Array.prototype.indexOf||u.indexOf; $.extend(m.defaults,m.render_defaults,m.shared_defaults);$.extend(m.area_defaults,m.render_defaults,m.shared_defaults)};me.test=function(obj){return eval(obj)};return me}();$.mapster.impl.init()})(jQuery);